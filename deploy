#!/bin/bash
set -euo pipefail

cd "$(dirname "$0")"

echo "=== Verify first ==="
./verify

echo "=== Deploy to fly.io ==="
cd server

# Ensure admin credentials are set
if ! fly secrets list -a jonobabytrack | grep -q ADMIN_USER; then
  echo "Setting up admin credentials..."
  read -p "Admin username: " admin_user
  read -sp "Admin password: " admin_pass
  echo
  fly secrets set ADMIN_USER="$admin_user" ADMIN_PASS="$admin_pass" -a babytrack
fi

fly deploy --ha=false

echo ""
echo "✓ Deployed"
echo "View logs: fly logs -a jonobabytrack"

# smoke test prod
echo "=== Smoke test production ==="
sleep 5
if ! curl -fsS http://jonobabytrack.fly.dev/health >/dev/null; then
  echo "✗ Smoke test failed"
  exit 1
fi